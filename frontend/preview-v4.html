<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EscrowBase - Preview v4 (USDM Yield)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    @keyframes spin { to { transform: rotate(360deg); } }
    .animate-spin { animation: spin 1s linear infinite; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    .animate-fadeIn { animation: fadeIn 0.3s ease-out; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
    .animate-pulse { animation: pulse 2s ease-in-out infinite; }
    @keyframes countUp { from { opacity: 0.5; } to { opacity: 1; } }
    .yield-tick { animation: countUp 0.1s ease-out; }
    .gradient-text {
      background: linear-gradient(135deg, #10b981 0%, #34d399 50%, #6ee7b7 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <script type="text/babel">
    const { useState, useEffect, useRef, useCallback } = React;

    // ============ YIELD CALCULATION (USDM 5% APY) ============
    const USDM_APY = 0.05; // 5% annual yield from Mountain Protocol
    const SECONDS_PER_YEAR = 365 * 24 * 60 * 60;
    
    function calculateYieldPerSecond(principalUSDC) {
      return (principalUSDC * USDM_APY) / SECONDS_PER_YEAR;
    }

    // ============ LIVE YIELD TICKER HOOK ============
    function useLiveYield(principal, depositTimestamp, isActive) {
      const [currentYield, setCurrentYield] = useState(0);
      const [currentBalance, setCurrentBalance] = useState(principal);
      const yieldPerSecond = calculateYieldPerSecond(principal);
      const frameRef = useRef();
      const lastUpdateRef = useRef(Date.now());

      useEffect(() => {
        if (!isActive || !depositTimestamp) return;

        const startTime = new Date(depositTimestamp).getTime();
        
        const updateYield = () => {
          const now = Date.now();
          const elapsedSeconds = (now - startTime) / 1000;
          const accruedYield = principal * USDM_APY * (elapsedSeconds / SECONDS_PER_YEAR);
          
          setCurrentYield(accruedYield);
          setCurrentBalance(principal + accruedYield);
          
          frameRef.current = requestAnimationFrame(updateYield);
        };

        frameRef.current = requestAnimationFrame(updateYield);
        
        return () => {
          if (frameRef.current) {
            cancelAnimationFrame(frameRef.current);
          }
        };
      }, [principal, depositTimestamp, isActive]);

      return { currentYield, currentBalance, yieldPerSecond };
    }

    // ============ LIVE YIELD TICKER COMPONENT ============
    const LiveYieldTicker = ({ principal, depositTimestamp, isActive }) => {
      const { currentYield, currentBalance, yieldPerSecond } = useLiveYield(
        principal,
        depositTimestamp,
        isActive
      );

      const formatCurrency = (amount, decimals = 2) => {
        return new Intl.NumberFormat('en-US', {
          style: 'currency',
          currency: 'USD',
          minimumFractionDigits: decimals,
          maximumFractionDigits: decimals,
        }).format(amount);
      };

      const formatYield = (amount) => {
        // Show more decimal places for small amounts
        if (amount < 0.01) return formatCurrency(amount, 6);
        if (amount < 1) return formatCurrency(amount, 4);
        return formatCurrency(amount, 2);
      };

      // Calculate time since deposit
      const getTimeElapsed = () => {
        if (!depositTimestamp) return { days: 0, hours: 0, minutes: 0, seconds: 0 };
        const elapsed = Date.now() - new Date(depositTimestamp).getTime();
        const days = Math.floor(elapsed / (1000 * 60 * 60 * 24));
        const hours = Math.floor((elapsed % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((elapsed % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((elapsed % (1000 * 60)) / 1000);
        return { days, hours, minutes, seconds };
      };

      const time = getTimeElapsed();

      if (!isActive) {
        return (
          <div className="bg-gradient-to-br from-gray-700 to-gray-800 text-white rounded-lg p-6">
            <div className="flex items-center gap-2 mb-4">
              <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              <span className="font-medium">Awaiting Funds</span>
            </div>
            <p className="text-gray-300 text-sm">Interest will begin accruing once funds are received</p>
          </div>
        );
      }

      return (
        <div className="bg-gradient-to-br from-emerald-500 via-green-500 to-teal-600 text-white rounded-lg p-6 relative overflow-hidden">
          {/* Animated background */}
          <div className="absolute inset-0 opacity-10">
            <div className="absolute inset-0" style={{
              backgroundImage: 'radial-gradient(circle at 2px 2px, white 1px, transparent 0)',
              backgroundSize: '32px 32px'
            }}></div>
          </div>
          
          <div className="relative z-10">
            {/* Header */}
            <div className="flex items-center justify-between mb-4">
              <div className="flex items-center gap-2">
                <div className="w-2 h-2 rounded-full bg-white animate-pulse"></div>
                <span className="font-medium">Live Interest</span>
              </div>
              <span className="text-xs bg-white/20 px-2 py-1 rounded-full">
                {USDM_APY * 100}% APY
              </span>
            </div>

            {/* Main Yield Display */}
            <div className="mb-6">
              <p className="text-xs text-green-100 uppercase tracking-wide mb-1">Accrued Interest</p>
              <div className="flex items-baseline gap-1">
                <span className="text-4xl font-bold tracking-tight yield-tick">
                  +{formatYield(currentYield)}
                </span>
              </div>
              <p className="text-xs text-green-200 mt-1">
                +{formatCurrency(yieldPerSecond * 60, 6)}/min
              </p>
            </div>

            {/* Stats Grid */}
            <div className="grid grid-cols-2 gap-4 pt-4 border-t border-white/20">
              <div>
                <p className="text-xs text-green-100">Principal</p>
                <p className="font-semibold">{formatCurrency(principal, 0)}</p>
              </div>
              <div>
                <p className="text-xs text-green-100">Current Value</p>
                <p className="font-semibold">{formatCurrency(currentBalance)}</p>
              </div>
            </div>

            {/* Time Elapsed */}
            <div className="mt-4 pt-4 border-t border-white/20">
              <p className="text-xs text-green-100 mb-2">Time in Escrow</p>
              <div className="flex gap-3 text-sm">
                {time.days > 0 && <span>{time.days}d</span>}
                <span>{String(time.hours).padStart(2, '0')}h</span>
                <span>{String(time.minutes).padStart(2, '0')}m</span>
                <span className="font-mono">{String(time.seconds).padStart(2, '0')}s</span>
              </div>
            </div>

            {/* Powered By */}
            <div className="mt-4 pt-4 border-t border-white/20 flex items-center justify-between">
              <div className="flex items-center gap-2">
                <div className="w-4 h-4 rounded-full bg-white/20 flex items-center justify-center">
                  <span className="text-[8px] font-bold">M</span>
                </div>
                <span className="text-xs text-green-200">Powered by Mountain Protocol (USDM)</span>
              </div>
            </div>
          </div>
        </div>
      );
    };

    // Payee Types - Full List
    const payeeTypes = [
      { value: 'BUYER', label: 'Buyer' },
      { value: 'SELLER', label: 'Seller' },
      { value: 'BUYER_AGENT', label: "Buyer's Real Estate Agent (Selling Agent)" },
      { value: 'LISTING_AGENT', label: "Seller's Real Estate Agent (Listing Agent)" },
      { value: 'BUYER_LENDER', label: "Buyer's Lender (if financed)" },
      { value: 'LOAN_OFFICER', label: 'Loan Officer / Mortgage Broker' },
      { value: 'ESCROW_COMPANY', label: 'Escrow Officer / Escrow Company' },
      { value: 'TITLE_INSURANCE', label: 'Title Insurance Company' },
      { value: 'UNDERWRITER', label: 'Underwriter (Lender Side)' },
      { value: 'APPRAISER', label: 'Appraiser' },
      { value: 'APPRAISAL_MGMT', label: 'Appraisal Management Company' },
      { value: 'HOME_INSURANCE', label: 'Homeowners Insurance Company' },
      { value: 'NOTARY', label: 'Notary Public / Mobile Notary' },
      { value: 'TC_BUYER', label: 'Transaction Coordinator (Buyer Side)' },
      { value: 'TC_SELLER', label: 'Transaction Coordinator (Seller Side)' },
      { value: 'HOA', label: 'HOA / Condo Association (if applicable)' },
      { value: 'HOA_MGMT', label: 'HOA Management Company' },
      { value: 'MORTGAGE_PAYOFF', label: "Mortgage Payoff Lender (Seller's Existing Loan)" },
      { value: 'HELOC_LENDER', label: 'HELOC Lender (if applicable)' },
      { value: 'LIEN_HOLDER', label: 'Other Lien Holders (Tax, Judgment, Mechanics, etc.)' },
      { value: 'PROPERTY_TAX', label: 'Property Tax Authority' },
      { value: 'COUNTY_RECORDER', label: 'County Recorder' },
      { value: 'HAZARD_DISCLOSURE', label: 'Natural Hazard Disclosure Provider' },
      { value: 'HOME_WARRANTY', label: 'Home Warranty Company (if applicable)' },
      { value: 'COURIER_SERVICE', label: 'Courier / Wire / Recording Service Providers' },
      { value: 'CREDIT_AGENCY', label: 'Credit Reporting Agency' },
      { value: 'OTHER', label: 'Other' },
    ];

    // Mock Data - Simulating funded 2 days ago
    const twoHoursAgo = new Date(Date.now() - 2 * 60 * 60 * 1000).toISOString();
    const twoDaysAgo = new Date(Date.now() - 2 * 24 * 60 * 60 * 1000).toISOString();
    
    const mockEscrows = [
      {
        id: 'ESC-2024-001847',
        propertyAddress: '123 Oak Lane, Beverly Hills, CA 90210',
        purchasePrice: 1250000,
        status: 'FUNDS_RECEIVED',
        createdAt: '2024-12-10T10:00:00Z',
        fundedAt: twoDaysAgo,
        accountId: 'ACC-847562901',
        currentBalance: 1250000,
        payeeCount: 3,
        buyer: {
          firstName: 'Michael',
          lastName: 'Johnson',
          email: 'michael.johnson@email.com'
        },
        wiringInstructions: {
          bankName: 'EscrowBase Trust',
          routingNumber: '021000089',
          accountNumber: '8847562901',
          reference: 'ESC-2024-001847',
          beneficiaryName: 'EscrowBase LLC FBO Oak Lane',
        },
        payees: [
          { id: 'p1', firstName: 'John', lastName: 'Smith', name: 'John Smith', type: 'SELLER', email: 'john.smith@email.com', paymentMethod: 'WIRE', amount: 1150000, status: 'PENDING' },
          { id: 'p2', firstName: 'Sarah', lastName: 'Johnson', name: 'Sarah Johnson', type: 'LISTING_AGENT', email: 'sarah@realty.com', paymentMethod: 'ACH', basisPoints: 300, usePercentage: true, status: 'PENDING' },
          { id: 'p3', firstName: 'Mike', lastName: 'Chen', name: 'Mike Chen', type: 'BUYER_AGENT', email: 'mike@homes.com', paymentMethod: 'ACH', basisPoints: 250, usePercentage: true, status: 'PENDING' },
        ]
      },
      {
        id: 'ESC-2024-001902',
        propertyAddress: '456 Maple Street, Pasadena, CA 91101',
        purchasePrice: 875000,
        status: 'CREATED',
        createdAt: '2024-12-11T14:30:00Z',
        currentBalance: 0,
        payeeCount: 0,
        buyer: {
          firstName: 'Emily',
          lastName: 'Davis',
          email: 'emily.davis@email.com'
        },
      },
      {
        id: 'ESC-2024-001756',
        propertyAddress: '789 Pine Ave, Santa Monica, CA 90401',
        purchasePrice: 2100000,
        status: 'CLOSED',
        createdAt: '2024-11-15T09:00:00Z',
        currentBalance: 0,
        payeeCount: 4,
      },
    ];

    // Status Configurations
    const statusConfig = {
      CREATED: { label: 'Awaiting Funds', color: 'bg-yellow-100 text-yellow-800' },
      FUNDS_RECEIVED: { label: 'Funded', color: 'bg-green-100 text-green-800' },
      READY_TO_CLOSE: { label: 'Ready to Close', color: 'bg-blue-100 text-blue-800' },
      CLOSED: { label: 'Closed', color: 'bg-gray-100 text-gray-800' },
    };

    const paymentMethodLabels = {
      INSTANT: 'Instant Transfer',
      WIRE: 'Wire Transfer',
      ACH: 'ACH Transfer',
      PHYSICAL_CHECK: 'Physical Check',
    };

    const getPayeeTypeLabel = (typeValue) => {
      const type = payeeTypes.find(t => t.value === typeValue);
      return type ? type.label : typeValue;
    };

    const formatCurrency = (amount) => {
      return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD',
        minimumFractionDigits: 0,
        maximumFractionDigits: 2,
      }).format(amount);
    };

    // Navbar Component
    const Navbar = ({ connected, onConnect, onDisconnect, user }) => (
      <nav className="bg-white border-b border-gray-200 sticky top-0 z-50">
        <div className="max-w-7xl mx-auto px-4">
          <div className="flex items-center justify-between h-16">
            <div className="flex items-center gap-2">
              <div className="p-1.5 bg-blue-600 rounded-lg">
                <svg className="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                </svg>
              </div>
              <span className="font-bold text-xl text-gray-900">EscrowBase</span>
              <span className="ml-2 px-2 py-0.5 text-xs font-medium bg-emerald-100 text-emerald-700 rounded-full">5% APY</span>
            </div>
            
            <div className="flex items-center gap-4">
              {connected ? (
                <div className="flex items-center gap-3">
                  <div className="flex items-center gap-2 px-3 py-1.5 bg-gray-100 rounded-lg">
                    <div className="w-8 h-8 rounded-full bg-blue-600 flex items-center justify-center text-white font-medium">
                      {user?.name?.charAt(0) || 'U'}
                    </div>
                    <span className="text-sm font-medium">{user?.name || 'User'}</span>
                  </div>
                  <button 
                    onClick={onDisconnect}
                    className="text-sm text-gray-600 hover:text-red-600"
                  >
                    Sign Out
                  </button>
                </div>
              ) : (
                <button 
                  onClick={onConnect}
                  className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium"
                >
                  Sign In
                </button>
              )}
            </div>
          </div>
        </div>
      </nav>
    );

    // Dashboard Page
    const Dashboard = ({ escrows, onSelectEscrow, onNewEscrow }) => {
      const [search, setSearch] = useState('');
      
      const stats = {
        total: escrows.length,
        active: escrows.filter(e => !['CLOSED'].includes(e.status)).length,
        totalValue: escrows.reduce((sum, e) => sum + e.purchasePrice, 0),
        pendingClose: escrows.filter(e => e.status === 'FUNDS_RECEIVED').length,
      };

      const filtered = escrows.filter(e => 
        e.propertyAddress.toLowerCase().includes(search.toLowerCase()) ||
        e.id.toLowerCase().includes(search.toLowerCase())
      );

      return (
        <div className="space-y-8">
          {/* Hero Stats */}
          <div className="bg-gradient-to-r from-slate-900 to-slate-800 rounded-2xl p-8 text-white">
            <div className="flex justify-between items-start">
              <div>
                <h1 className="text-2xl font-bold mb-2">Dashboard</h1>
                <p className="text-slate-400">Manage your escrow accounts and track yields</p>
              </div>
              <div className="text-right">
                <p className="text-sm text-slate-400">Current APY</p>
                <p className="text-3xl font-bold gradient-text">5.00%</p>
                <p className="text-xs text-slate-500 mt-1">Powered by USDM</p>
              </div>
            </div>
            
            <div className="grid grid-cols-4 gap-6 mt-8">
              {[
                { label: 'Total Escrows', value: stats.total, color: 'text-white' },
                { label: 'Active', value: stats.active, color: 'text-green-400' },
                { label: 'Total Value', value: formatCurrency(stats.totalValue), color: 'text-white' },
                { label: 'Ready to Close', value: stats.pendingClose, color: 'text-blue-400' },
              ].map((stat, i) => (
                <div key={i}>
                  <p className="text-sm text-slate-400">{stat.label}</p>
                  <p className={`text-2xl font-bold ${stat.color}`}>{stat.value}</p>
                </div>
              ))}
            </div>
          </div>

          {/* Actions */}
          <div className="flex justify-between items-center">
            <div className="relative flex-1 max-w-md">
              <svg className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
              </svg>
              <input
                type="text"
                placeholder="Search by property address or escrow ID..."
                value={search}
                onChange={(e) => setSearch(e.target.value)}
                className="w-full pl-10 pr-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
              />
            </div>
            <button 
              onClick={onNewEscrow}
              className="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
            >
              <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
              </svg>
              New Escrow
            </button>
          </div>

          {/* Escrow List */}
          <div className="bg-white rounded-lg border">
            <div className="p-6 border-b">
              <h2 className="text-lg font-semibold">Your Escrows</h2>
              <p className="text-sm text-gray-500">Click to view details and manage disbursements</p>
            </div>
            <div className="divide-y">
              {filtered.map((escrow) => (
                <button
                  key={escrow.id}
                  onClick={() => onSelectEscrow(escrow)}
                  className="w-full p-4 hover:bg-gray-50 text-left flex items-center justify-between"
                >
                  <div className="flex items-center gap-4">
                    <div className="p-2 bg-blue-50 rounded-lg">
                      <svg className="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                      </svg>
                    </div>
                    <div>
                      <h4 className="font-medium text-gray-900">{escrow.propertyAddress}</h4>
                      <div className="flex items-center gap-3 mt-1 text-sm text-gray-500">
                        <span className="font-mono text-xs">{escrow.id}</span>
                        <span>â€¢</span>
                        <span>{formatCurrency(escrow.purchasePrice)}</span>
                        <span>â€¢</span>
                        <span>{escrow.payeeCount} payees</span>
                      </div>
                    </div>
                  </div>
                  <div className="flex items-center gap-3">
                    {escrow.status === 'FUNDS_RECEIVED' && (
                      <span className="text-sm text-emerald-600 font-medium flex items-center gap-1">
                        <span className="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span>
                        Earning 5% APY
                      </span>
                    )}
                    <span className={`px-3 py-1 rounded-full text-xs font-medium ${statusConfig[escrow.status].color}`}>
                      {statusConfig[escrow.status].label}
                    </span>
                  </div>
                </button>
              ))}
            </div>
          </div>
        </div>
      );
    };

    // Escrow Detail Page with Live Yield
    const EscrowDetail = ({ escrow, onBack, showToast }) => {
      const [activeTab, setActiveTab] = useState('disbursements');
      const [showAddPayee, setShowAddPayee] = useState(false);
      const [payees, setPayees] = useState(escrow.payees || []);
      const [payeeForm, setPayeeForm] = useState({
        firstName: '',
        lastName: '',
        email: '',
        type: 'SELLER',
        paymentMethod: 'WIRE',
        amount: ''
      });

      const isActive = escrow.status === 'FUNDS_RECEIVED';
      const depositTimestamp = escrow.fundedAt || escrow.createdAt;

      const totalToPayees = payees.reduce((sum, p) => {
        const amt = p.usePercentage ? (escrow.purchasePrice * p.basisPoints / 10000) : (p.amount || 0);
        return sum + amt;
      }, 0);

      const handleAddPayee = () => {
        const newPayee = {
          id: 'p' + (payees.length + 1),
          firstName: payeeForm.firstName,
          lastName: payeeForm.lastName,
          name: `${payeeForm.firstName} ${payeeForm.lastName}`,
          email: payeeForm.email,
          type: payeeForm.type,
          paymentMethod: payeeForm.paymentMethod,
          amount: parseInt(payeeForm.amount.replace(/[^0-9]/g, '')) || 50000,
          status: 'PENDING'
        };
        setPayees([...payees, newPayee]);
        setShowAddPayee(false);
        setPayeeForm({ firstName: '', lastName: '', email: '', type: 'SELLER', paymentMethod: 'WIRE', amount: '' });
        showToast('Payee added successfully!');
      };

      const formatAmount = (value) => {
        const numbers = value.replace(/[^0-9]/g, '');
        if (!numbers) return '';
        return new Intl.NumberFormat('en-US', {
          style: 'currency',
          currency: 'USD',
          minimumFractionDigits: 0,
        }).format(parseInt(numbers));
      };

      return (
        <div className="space-y-6">
          {/* Header */}
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-4">
              <button onClick={onBack} className="p-2 hover:bg-gray-100 rounded-lg">
                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
                </svg>
              </button>
              <div>
                <h1 className="text-xl font-bold">{escrow.propertyAddress}</h1>
                <p className="text-sm text-gray-500">Escrow ID: {escrow.id}</p>
              </div>
            </div>
            <span className={`px-3 py-1.5 rounded-full text-sm font-medium ${statusConfig[escrow.status].color}`}>
              {statusConfig[escrow.status].label}
            </span>
          </div>

          <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
            {/* Main Content */}
            <div className="lg:col-span-2 space-y-6">
              {/* Progress */}
              <div className="bg-white rounded-lg border p-6">
                <div className="flex justify-between mb-4">
                  <span className="font-medium">Escrow Progress</span>
                  <span className="text-sm text-gray-500">
                    {escrow.status === 'CLOSED' ? '100%' : escrow.status === 'FUNDS_RECEIVED' ? '50%' : '25%'} Complete
                  </span>
                </div>
                <div className="h-2 bg-gray-200 rounded-full overflow-hidden">
                  <div 
                    className="h-full bg-blue-600 transition-all"
                    style={{ width: escrow.status === 'CLOSED' ? '100%' : escrow.status === 'FUNDS_RECEIVED' ? '50%' : '25%' }}
                  />
                </div>
                <div className="flex justify-between mt-4 text-xs text-gray-500">
                  {['Created', 'Funded', 'Payees Added', 'Closed'].map((label, i) => {
                    const complete = (escrow.status === 'CLOSED') ||
                      (i === 0) ||
                      (i === 1 && ['FUNDS_RECEIVED', 'CLOSED'].includes(escrow.status)) ||
                      (i === 2 && payees.length > 0);
                    return (
                      <div key={label} className="flex flex-col items-center">
                        <div className={`w-6 h-6 rounded-full flex items-center justify-center mb-1 ${complete ? 'bg-green-500 text-white' : 'bg-gray-200'}`}>
                          {complete ? 'âœ“' : i + 1}
                        </div>
                        <span>{label}</span>
                      </div>
                    );
                  })}
                </div>
              </div>

              {/* Tabs */}
              <div>
                <div className="flex gap-1 p-1 bg-gray-100 rounded-lg w-fit">
                  {['Disbursements', 'Activity', 'Documents'].map((tab) => (
                    <button
                      key={tab}
                      onClick={() => setActiveTab(tab.toLowerCase())}
                      className={`px-4 py-2 rounded-md text-sm font-medium transition-colors
                        ${activeTab === tab.toLowerCase() ? 'bg-white shadow-sm' : 'text-gray-600 hover:text-gray-900'}
                      `}
                    >
                      {tab}
                    </button>
                  ))}
                </div>

                {activeTab === 'disbursements' && (
                  <div className="mt-4 space-y-4">
                    {/* Payees Card */}
                    <div className="bg-white rounded-lg border">
                      <div className="p-4 border-b flex justify-between items-center">
                        <div>
                          <h3 className="font-medium">Payees ({payees.length})</h3>
                          <p className="text-sm text-gray-500">Configure disbursement recipients</p>
                        </div>
                        {!showAddPayee && escrow.status !== 'CLOSED' && (
                          <button
                            onClick={() => setShowAddPayee(true)}
                            className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm"
                          >
                            Add Payee
                          </button>
                        )}
                      </div>

                      <div className="p-4 space-y-3">
                        {/* Add Payee Form */}
                        {showAddPayee && (
                          <div className="border-2 border-dashed border-slate-200 rounded-lg p-4 bg-slate-50">
                            <h4 className="font-medium mb-4">Add New Payee</h4>
                            <div className="space-y-4">
                              <div className="grid grid-cols-2 gap-4">
                                <div>
                                  <label className="block text-sm font-medium mb-1">First Name</label>
                                  <input 
                                    type="text" 
                                    placeholder="John"
                                    value={payeeForm.firstName}
                                    onChange={(e) => setPayeeForm({...payeeForm, firstName: e.target.value})}
                                    className="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" 
                                  />
                                </div>
                                <div>
                                  <label className="block text-sm font-medium mb-1">Last Name</label>
                                  <input 
                                    type="text" 
                                    placeholder="Smith"
                                    value={payeeForm.lastName}
                                    onChange={(e) => setPayeeForm({...payeeForm, lastName: e.target.value})}
                                    className="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" 
                                  />
                                </div>
                              </div>
                              
                              <div>
                                <label className="block text-sm font-medium mb-1">Email</label>
                                <input 
                                  type="email" 
                                  placeholder="john.smith@email.com"
                                  value={payeeForm.email}
                                  onChange={(e) => setPayeeForm({...payeeForm, email: e.target.value})}
                                  className="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" 
                                />
                              </div>

                              <div className="grid grid-cols-2 gap-4">
                                <div>
                                  <label className="block text-sm font-medium mb-1">Type</label>
                                  <select 
                                    value={payeeForm.type}
                                    onChange={(e) => setPayeeForm({...payeeForm, type: e.target.value})}
                                    className="w-full px-3 py-2 border rounded-lg bg-white focus:outline-none focus:ring-2 focus:ring-blue-500"
                                  >
                                    {payeeTypes.map((type) => (
                                      <option key={type.value} value={type.value}>{type.label}</option>
                                    ))}
                                  </select>
                                </div>
                                <div>
                                  <label className="block text-sm font-medium mb-1">Payment Method</label>
                                  <select 
                                    value={payeeForm.paymentMethod}
                                    onChange={(e) => setPayeeForm({...payeeForm, paymentMethod: e.target.value})}
                                    className="w-full px-3 py-2 border rounded-lg bg-white focus:outline-none focus:ring-2 focus:ring-blue-500"
                                  >
                                    <option value="WIRE">Wire Transfer</option>
                                    <option value="ACH">ACH Transfer</option>
                                    <option value="INSTANT">Instant Transfer</option>
                                    <option value="PHYSICAL_CHECK">Physical Check</option>
                                  </select>
                                </div>
                              </div>

                              <div>
                                <label className="block text-sm font-medium mb-1">Amount</label>
                                <input 
                                  type="text" 
                                  placeholder="$50,000"
                                  value={payeeForm.amount}
                                  onChange={(e) => setPayeeForm({...payeeForm, amount: formatAmount(e.target.value)})}
                                  className="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" 
                                />
                              </div>
                            </div>
                            <div className="flex justify-end gap-2 mt-4 pt-4 border-t">
                              <button onClick={() => setShowAddPayee(false)} className="px-4 py-2 border rounded-lg hover:bg-gray-50">Cancel</button>
                              <button 
                                onClick={handleAddPayee}
                                disabled={!payeeForm.firstName || !payeeForm.lastName || !payeeForm.email}
                                className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed"
                              >
                                Add Payee
                              </button>
                            </div>
                          </div>
                        )}

                        {/* Payee List */}
                        {payees.length === 0 && !showAddPayee ? (
                          <div className="text-center py-12 bg-slate-50 rounded-lg border-2 border-dashed">
                            <svg className="w-12 h-12 mx-auto text-slate-300 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                            </svg>
                            <p className="font-medium text-slate-600">No payees added yet</p>
                            <p className="text-sm text-slate-400 mt-1">Add sellers, agents, and other parties</p>
                          </div>
                        ) : (
                          payees.map((payee) => {
                            const amount = payee.usePercentage ? (escrow.purchasePrice * payee.basisPoints / 10000) : payee.amount;
                            return (
                              <div key={payee.id} className="border rounded-lg p-4 flex items-center justify-between">
                                <div className="flex items-center gap-4">
                                  <div className="p-2 bg-slate-100 rounded-lg">
                                    <svg className="w-4 h-4 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                                    </svg>
                                  </div>
                                  <div>
                                    <div className="flex items-center gap-2">
                                      <span className="font-medium">{payee.name}</span>
                                      <span className="px-2 py-0.5 bg-slate-100 text-slate-600 rounded text-xs">{payee.status}</span>
                                    </div>
                                    <p className="text-sm text-gray-500">{payee.email}</p>
                                    <p className="text-xs text-gray-400 mt-1">{getPayeeTypeLabel(payee.type)} â€¢ {paymentMethodLabels[payee.paymentMethod]}</p>
                                  </div>
                                </div>
                                <span className="text-lg font-semibold">{formatCurrency(amount)}</span>
                              </div>
                            );
                          })
                        )}
                      </div>
                    </div>
                  </div>
                )}

                {activeTab === 'activity' && (
                  <div className="mt-4 bg-white rounded-lg border p-6">
                    <div className="space-y-4">
                      {[
                        { date: 'Just now', action: 'Interest accruing', detail: 'Earning 5% APY via USDM', icon: 'ðŸ’°' },
                        { date: '2 days ago', action: 'Funds received', detail: '$1,250,000.00 deposited â†’ converted to USDM', icon: 'âœ“' },
                        { date: '2 days ago', action: 'Escrow created', detail: 'Account opened on Base L2', icon: 'ðŸ“„' },
                      ].map((event, i) => (
                        <div key={i} className="flex items-start gap-3">
                          <span className="text-lg">{event.icon}</span>
                          <div>
                            <p className="text-sm font-medium">{event.action}</p>
                            <p className="text-xs text-gray-500">{event.date} â€¢ {event.detail}</p>
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                )}

                {activeTab === 'documents' && (
                  <div className="mt-4 bg-white rounded-lg border p-6 space-y-3">
                    {['Wiring Instructions', 'Escrow Agreement', 'HUD-1 Settlement Statement'].map((doc, i) => (
                      <button key={i} className="w-full flex items-center justify-between px-4 py-3 border rounded-lg hover:bg-gray-50">
                        <div className="flex items-center gap-2">
                          <svg className="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                          </svg>
                          <span>{doc}</span>
                        </div>
                        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                        </svg>
                      </button>
                    ))}
                  </div>
                )}
              </div>
            </div>

            {/* Sidebar */}
            <div className="space-y-6">
              {/* LIVE YIELD TICKER */}
              <LiveYieldTicker 
                principal={escrow.purchasePrice}
                depositTimestamp={depositTimestamp}
                isActive={isActive}
              />

              {/* Buyer Card */}
              {escrow.buyer && (
                <div className="bg-white rounded-lg border p-6">
                  <h3 className="font-medium mb-4 flex items-center gap-2">
                    <svg className="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                    </svg>
                    Buyer (Yield Recipient)
                  </h3>
                  <div className="space-y-2">
                    <p className="font-medium">{escrow.buyer.firstName} {escrow.buyer.lastName}</p>
                    <p className="text-sm text-gray-600">{escrow.buyer.email}</p>
                    <p className="text-xs text-emerald-600 mt-2">All accrued interest will be rebated to buyer at closing</p>
                  </div>
                </div>
              )}

              {/* Wiring Instructions */}
              {escrow.wiringInstructions && (
                <div className="bg-white rounded-lg border p-6">
                  <h3 className="font-medium mb-4">Wiring Instructions</h3>
                  <div className="space-y-2 text-sm">
                    {Object.entries({
                      'Bank': escrow.wiringInstructions.bankName,
                      'Routing #': escrow.wiringInstructions.routingNumber,
                      'Account #': escrow.wiringInstructions.accountNumber,
                      'Reference': escrow.wiringInstructions.reference,
                    }).map(([k, v]) => (
                      <div key={k} className="flex justify-between">
                        <span className="text-gray-500">{k}</span>
                        <span className="font-mono">{v}</span>
                      </div>
                    ))}
                  </div>
                </div>
              )}

              {/* Close Escrow Button */}
              {escrow.status === 'FUNDS_RECEIVED' && payees.length > 0 && (
                <button 
                  onClick={() => showToast('Close escrow initiated! Swapping USDMâ†’USDC and distributing...')}
                  className="w-full py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 font-medium flex items-center justify-center gap-2"
                >
                  <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                  </svg>
                  Close Escrow & Disburse
                </button>
              )}
            </div>
          </div>
        </div>
      );
    };

    // New Escrow Page (simplified for this preview)
    const NewEscrow = ({ onBack, onCreated, showToast }) => {
      const [step, setStep] = useState('details');
      const [form, setForm] = useState({ 
        address: '', city: '', state: '', zip: '', price: '',
        buyerFirstName: '', buyerLastName: '', buyerEmail: ''
      });

      const handleSubmit = (e) => {
        e.preventDefault();
        setStep('creating');
        setTimeout(() => {
          showToast('Escrow created! Funds will earn 5% APY via USDM.');
          onCreated(mockEscrows[0]);
        }, 2000);
      };

      const formatPrice = (value) => {
        const numbers = value.replace(/[^0-9]/g, '');
        if (!numbers) return '';
        return '$' + parseInt(numbers).toLocaleString();
      };

      if (step === 'creating') {
        return (
          <div className="max-w-2xl mx-auto">
            <div className="bg-white rounded-lg border p-12 text-center">
              <div className="w-12 h-12 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
              <h3 className="text-lg font-medium">Setting Up Your Escrow</h3>
              <p className="text-gray-600 mt-1">Deploying secure vault on Base L2...</p>
            </div>
          </div>
        );
      }

      return (
        <div className="max-w-2xl mx-auto space-y-6">
          <div className="flex items-center gap-4">
            <button onClick={onBack} className="p-2 hover:bg-gray-100 rounded-lg">
              <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
              </svg>
            </button>
            <div>
              <h1 className="text-2xl font-bold">New Escrow</h1>
              <p className="text-gray-600">Funds will earn 5% APY while in escrow</p>
            </div>
          </div>

          <div className="bg-white rounded-lg border p-6">
            <form onSubmit={handleSubmit} className="space-y-6">
              <div>
                <h3 className="text-lg font-medium mb-4">Property Details</h3>
                <div className="space-y-4">
                  <input type="text" required placeholder="Street Address" value={form.address}
                    onChange={(e) => setForm({...form, address: e.target.value})}
                    className="w-full px-3 py-2 border rounded-lg" />
                  <div className="grid grid-cols-6 gap-4">
                    <input type="text" required placeholder="City" value={form.city}
                      onChange={(e) => setForm({...form, city: e.target.value})}
                      className="col-span-3 px-3 py-2 border rounded-lg" />
                    <input type="text" required placeholder="CA" maxLength={2} value={form.state}
                      onChange={(e) => setForm({...form, state: e.target.value.toUpperCase()})}
                      className="col-span-1 px-3 py-2 border rounded-lg" />
                    <input type="text" required placeholder="ZIP" value={form.zip}
                      onChange={(e) => setForm({...form, zip: e.target.value})}
                      className="col-span-2 px-3 py-2 border rounded-lg" />
                  </div>
                  <input type="text" required placeholder="Purchase Price" value={form.price}
                    onChange={(e) => setForm({...form, price: formatPrice(e.target.value)})}
                    className="w-full px-3 py-2 border rounded-lg" />
                </div>
              </div>

              <div className="border-t pt-6">
                <h3 className="text-lg font-medium mb-4">Buyer Information</h3>
                <div className="space-y-4">
                  <div className="grid grid-cols-2 gap-4">
                    <input type="text" required placeholder="First Name" value={form.buyerFirstName}
                      onChange={(e) => setForm({...form, buyerFirstName: e.target.value})}
                      className="px-3 py-2 border rounded-lg" />
                    <input type="text" required placeholder="Last Name" value={form.buyerLastName}
                      onChange={(e) => setForm({...form, buyerLastName: e.target.value})}
                      className="px-3 py-2 border rounded-lg" />
                  </div>
                  <input type="email" required placeholder="Email Address" value={form.buyerEmail}
                    onChange={(e) => setForm({...form, buyerEmail: e.target.value})}
                    className="w-full px-3 py-2 border rounded-lg" />
                </div>
              </div>

              <div className="flex justify-end gap-3 pt-4 border-t">
                <button type="button" onClick={onBack} className="px-4 py-2 border rounded-lg">Cancel</button>
                <button type="submit" className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                  Create Escrow
                </button>
              </div>
            </form>
          </div>
        </div>
      );
    };

    // Main App
    const App = () => {
      const [connected, setConnected] = useState(false);
      const [page, setPage] = useState('dashboard');
      const [selectedEscrow, setSelectedEscrow] = useState(null);
      const [user, setUser] = useState(null);
      const [toast, setToast] = useState(null);

      const showToast = (message) => {
        setToast(message);
        setTimeout(() => setToast(null), 4000);
      };

      const handleConnect = () => {
        setUser({ name: 'Randy Martinez', email: 'randy@escrowbase.com' });
        setConnected(true);
      };

      return (
        <div className="min-h-screen bg-gray-50">
          <Navbar connected={connected} user={user} onConnect={handleConnect}
            onDisconnect={() => { setConnected(false); setUser(null); }} />

          {toast && (
            <div className="fixed top-20 right-4 bg-green-600 text-white px-4 py-3 rounded-lg shadow-lg animate-fadeIn z-50 max-w-md">
              {toast}
            </div>
          )}
          
          <main className="max-w-7xl mx-auto px-4 py-8">
            {!connected ? (
              <div className="flex flex-col items-center justify-center min-h-[60vh] gap-6">
                <div className="text-center space-y-2">
                  <h1 className="text-3xl font-bold text-gray-900">Welcome to EscrowBase</h1>
                  <p className="text-gray-600 max-w-md">
                    Modern real estate escrow with <span className="text-emerald-600 font-semibold">5% APY</span> on deposited funds via Mountain Protocol (USDM).
                  </p>
                </div>
                <button onClick={handleConnect}
                  className="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium">
                  Sign In
                </button>
                <div className="grid grid-cols-3 gap-8 mt-12 max-w-3xl">
                  {[
                    { icon: 'ðŸ’°', title: '5% APY Interest', desc: 'Funds earn yield via USDM while in escrow' },
                    { icon: 'âš¡', title: 'Instant Settlement', desc: 'Built on Base L2 for fast, cheap transactions' },
                    { icon: 'ðŸ”’', title: 'Secure Multisig', desc: 'Protected by Safe smart accounts' },
                  ].map((f, i) => (
                    <div key={i} className="text-center">
                      <div className="text-3xl mb-2">{f.icon}</div>
                      <h3 className="font-medium">{f.title}</h3>
                      <p className="text-sm text-gray-500 mt-1">{f.desc}</p>
                    </div>
                  ))}
                </div>
              </div>
            ) : page === 'dashboard' ? (
              <Dashboard escrows={mockEscrows}
                onSelectEscrow={(escrow) => { setSelectedEscrow(escrow); setPage('detail'); }}
                onNewEscrow={() => setPage('new')} />
            ) : page === 'new' ? (
              <NewEscrow onBack={() => setPage('dashboard')}
                onCreated={(escrow) => { setSelectedEscrow(escrow); setPage('detail'); }}
                showToast={showToast} />
            ) : page === 'detail' && selectedEscrow ? (
              <EscrowDetail escrow={selectedEscrow} onBack={() => setPage('dashboard')} showToast={showToast} />
            ) : null}
          </main>
          
          <footer className="border-t mt-12 py-6 text-center text-sm text-gray-500">
            <p>Â© 2024 EscrowBase â€¢ Built on Base L2 â€¢ Yield via Mountain Protocol (USDM)</p>
          </footer>
        </div>
      );
    };

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
