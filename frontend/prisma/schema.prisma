// ============================================================================
// ESCROWBASE DATABASE SCHEMA
// ============================================================================
// 
// SECURITY ARCHITECTURE:
// ----------------------
// This schema follows a "Zero PII" principle for banking data.
// 
// ❌ WE DO NOT STORE:
//    - Bank account numbers
//    - Routing numbers  
//    - Full SSNs
//    - Any data that could be used for unauthorized wire transfers
//
// ✅ WE DO STORE:
//    - Bridge.xyz tokenized IDs (e.g., "ext_acct_abc123")
//    - Non-sensitive metadata (names, types, amounts)
//    - Our own internal reference IDs
//
// WHY THIS MATTERS:
// If our database is ever breached, attackers get NOTHING useful.
// They cannot initiate wire transfers with just a Bridge beneficiary ID.
// The actual bank details are encrypted and stored by Bridge.xyz,
// a SOC 2 Type II compliant financial infrastructure provider.
//
// ============================================================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// USER / AUTH
// ============================================================================

model User {
  id            String    @id @default(cuid())
  
  // Coinbase Smart Wallet address (public, not sensitive)
  walletAddress String    @unique
  
  // Display name (optional, user-provided)
  displayName   String?
  
  // Email for notifications (optional)
  email         String?
  
  // Role-based access
  role          UserRole  @default(ESCROW_OFFICER)
  
  // Timestamps
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  lastLoginAt   DateTime?
  
  // Relations
  escrows       Escrow[]
  
  @@index([walletAddress])
}

enum UserRole {
  ESCROW_OFFICER
  ADMIN
  VIEWER
}

// ============================================================================
// ESCROW
// ============================================================================

model Escrow {
  id              String       @id @default(cuid())
  
  // Human-readable escrow ID (e.g., "ESC-2024-001847")
  escrowId        String       @unique
  
  // Property details (non-sensitive)
  propertyAddress String
  city            String
  state           String
  zipCode         String
  purchasePrice   Decimal      @db.Decimal(18, 2)
  
  // Buyer info (for wiring instructions)
  buyerFirstName  String
  buyerLastName   String
  buyerEmail      String
  
  // ══════════════════════════════════════════════════════════════════════════
  // BRIDGE.XYZ TOKENIZED REFERENCES (Compliant Architecture)
  // ══════════════════════════════════════════════════════════════════════════
  // 
  // NON-COMMINGLING COMPLIANCE:
  // Each escrow gets its own segregated custodial wallet via Bridge's 
  // Wallet-as-a-Service. Funds for "Deal A" never touch "Deal B".
  //
  // NO MONEY TRANSMISSION:
  // We NEVER hold private keys. Bridge is the Qualified Custodian.
  // All funds are held in Bridge-controlled custodial wallets.
  //
  // ══════════════════════════════════════════════════════════════════════════
  
  // Bridge Customer ID (represents the Buyer for KYC purposes)
  bridgeCustomerId        String?
  
  // Segregated Custodial Wallet ID (unique per deal - NON-COMMINGLING)
  bridgeWalletId          String?
  
  // On-chain wallet address (for the segregated wallet)
  bridgeWalletAddress     String?
  
  // Virtual Account ID (for receiving wire/ACH deposits)
  bridgeVirtualAccountId  String?
  
  // On-chain references (public blockchain data, not sensitive)
  vaultAddress    String?      // Smart contract address on Base
  safeAddress     String?      // Gnosis Safe multisig address
  
  // Status tracking
  status          EscrowStatus @default(CREATED)
  
  // Financial tracking (we track amounts, not bank details)
  initialDeposit  Decimal?     @db.Decimal(18, 6)  // Initial USDB deposited
  currentBalance  Decimal?     @db.Decimal(18, 6)  // Current USDB balance (includes yield)
  
  // ══════════════════════════════════════════════════════════════════════════
  // YIELD SETTINGS
  // ══════════════════════════════════════════════════════════════════════════
  // Buyer can choose whether to earn yield on their escrowed funds.
  // - yieldEnabled = true  → Use USDB (yield-earning stablecoin)
  // - yieldEnabled = false → Use USDC (standard stablecoin, no yield)
  // ══════════════════════════════════════════════════════════════════════════
  yieldEnabled    Boolean      @default(true)  // true = USDB (yield), false = USDC (no yield)
  
  // ══════════════════════════════════════════════════════════════════════════
  // YIELD TRACKING (Only applies if yieldEnabled = true)
  // ══════════════════════════════════════════════════════════════════════════
  // LEGAL REQUIREMENT: 100% of yield MUST go to the buyer (depositor).
  // Neither EscrowPayi nor the Escrow Agent can keep any yield.
  // We track this to ensure full compliance at escrow close.
  // ══════════════════════════════════════════════════════════════════════════
  yieldEarned     Decimal?     @db.Decimal(18, 6)  // Yield accrued (currentBalance - initialDeposit)
  yieldReturnedTo String?      // "BUYER" - confirms yield was returned to depositor
  
  // Transaction hashes (public blockchain data)
  depositTxHash   String?
  closeTxHash     String?
  
  // Timestamps
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  fundedAt        DateTime?
  closedAt        DateTime?
  
  // Relations
  createdBy       User         @relation(fields: [createdById], references: [id])
  createdById     String
  payees          Payee[]
  activityLogs    ActivityLog[]
  
  @@index([escrowId])
  @@index([status])
  @@index([createdById])
}

enum EscrowStatus {
  CREATED           // Escrow opened, awaiting funds
  DEPOSIT_PENDING   // Wire initiated, not yet received
  FUNDS_RECEIVED    // USDC received in Safe, ready for payee setup
  READY_TO_CLOSE    // All payees configured, ready for disbursement
  CLOSING           // Close transaction in progress
  CLOSED            // All funds disbursed
  CANCELLED         // Escrow cancelled
}

// ============================================================================
// PAYEE (TOKENIZED BANK REFERENCES)
// ============================================================================
// 
// ⚠️  CRITICAL SECURITY DESIGN ⚠️
// 
// This table stores REFERENCES to bank accounts, NOT the actual bank data.
// 
// The `bridgeBeneficiaryId` is a token issued by Bridge.xyz when we submit
// the payee's bank details through their secure API. Bridge stores the
// actual routing/account numbers in their PCI-compliant, SOC 2 vault.
//
// WHAT HAPPENS WHEN WE ADD A PAYEE:
// 1. User enters: Name, Bank Name, Routing #, Account #
// 2. We POST to Bridge.xyz /external_accounts
// 3. Bridge returns: { id: "ext_acct_abc123", ... }
// 4. We store ONLY the id in `bridgeBeneficiaryId`
// 5. We IMMEDIATELY DISCARD the routing/account numbers
// 6. They are NEVER written to our database or logs
//
// WHAT HAPPENS WHEN WE PAY A PAYEE:
// 1. We call Bridge.xyz POST /transfers with the beneficiary_id
// 2. Bridge looks up the actual bank details in THEIR vault
// 3. Bridge initiates the wire/ACH
// 4. We never see the bank details again
//
// ============================================================================

model Payee {
  id              String       @id @default(cuid())
  
  // ══════════════════════════════════════════════════════════════════════════
  // SAFE TO STORE: Non-sensitive identifiers
  // ══════════════════════════════════════════════════════════════════════════
  firstName       String
  lastName        String
  email           String?
  
  // Payee classification (for reporting, not security-sensitive)
  payeeType       PayeeType
  
  // ══════════════════════════════════════════════════════════════════════════
  // TOKENIZED BANK REFERENCE (Bridge.xyz)
  // ══════════════════════════════════════════════════════════════════════════
  // This is the ONLY banking reference we store.
  // Format: "ext_acct_xxxxxxxxxxxx" 
  // This token is USELESS without Bridge.xyz API credentials.
  // Even if stolen, an attacker cannot:
  //   - Retrieve the bank account number
  //   - Retrieve the routing number
  //   - Initiate transfers (requires our API key + webhook verification)
  // ══════════════════════════════════════════════════════════════════════════
  bridgeBeneficiaryId  String
  
  // ══════════════════════════════════════════════════════════════════════════
  // SAFE TO STORE: Non-sensitive bank metadata
  // ══════════════════════════════════════════════════════════════════════════
  // We store the bank NAME for display purposes only.
  // This is public information (you can Google any bank's name).
  bankName        String?
  
  // Last 4 digits of account (for user verification UI)
  // This is standard practice and not sufficient for fraud.
  accountLast4    String?
  
  // ══════════════════════════════════════════════════════════════════════════
  // USDC DIRECT PAYMENT (for crypto-native payees)
  // ══════════════════════════════════════════════════════════════════════════
  // Wallet address for direct USDC transfers on Base
  // This is a public blockchain address, not sensitive data.
  walletAddress   String?
  
  // Payment method preference
  paymentMethod   PaymentMethod
  
  // ══════════════════════════════════════════════════════════════════════════
  // FINANCIAL DATA (amounts, not bank details)
  // ══════════════════════════════════════════════════════════════════════════
  amount          Decimal?     @db.Decimal(18, 2)  // Fixed amount
  basisPoints     Int?         // Percentage of purchase price (e.g., 300 = 3%)
  
  // Status
  status          PayeeStatus  @default(PENDING)
  
  // Bridge transfer reference (for tracking payout)
  bridgeTransferId    String?
  
  // Timestamps  
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  paidAt          DateTime?
  
  // Relations
  escrow          Escrow       @relation(fields: [escrowId], references: [id], onDelete: Cascade)
  escrowId        String
  
  @@index([escrowId])
  @@index([bridgeBeneficiaryId])
  @@index([status])
}

enum PayeeType {
  // Primary Parties
  BUYER
  SELLER
  // Real Estate Agents
  BUYER_AGENT           // Buyer's Agent (Selling Agent)
  LISTING_AGENT         // Seller's Agent (Listing Agent)
  // Lenders & Mortgage
  BUYER_LENDER          // Buyer's Lender (if financed)
  LOAN_OFFICER          // Loan Officer / Mortgage Broker
  MORTGAGE_PAYOFF       // Mortgage Payoff (Seller's Existing Loan)
  HELOC_LENDER          // HELOC Lender (if applicable)
  // Title & Escrow
  ESCROW_COMPANY        // Escrow Officer / Escrow Company
  TITLE_INSURANCE       // Title Insurance Company
  UNDERWRITER           // Underwriter (Lender Side)
  // Appraisal
  APPRAISER             // Appraiser
  APPRAISAL_MGMT        // Appraisal Management Company
  // Insurance & Warranty
  HOME_INSURANCE        // Homeowners Insurance Company
  HOME_WARRANTY         // Home Warranty Company (if applicable)
  // Transaction Support
  NOTARY                // Notary Public / Mobile Notary
  TC_BUYER              // Transaction Coordinator (Buyer Side)
  TC_SELLER             // Transaction Coordinator (Seller Side)
  COURIER_SERVICE       // Courier / Wire / Recording Service Providers
  // HOA / Condo
  HOA                   // HOA / Condo Association (if applicable)
  HOA_MGMT              // HOA Management Company
  // Liens & Payoffs
  LIEN_HOLDER           // Other Lien Holders (Tax, Judgment, Mechanics, etc.)
  // Government
  PROPERTY_TAX          // Property Tax Authority
  COUNTY_RECORDER       // County Recorder
  // Other Services
  HAZARD_DISCLOSURE     // Natural Hazard Disclosure Provider (state-dependent)
  CREDIT_AGENCY         // Credit Reporting Agency (indirect, lender-related)
  OTHER                 // Other
}

enum PaymentMethod {
  USDC          // Direct USDC transfer on Base (instant)
  WIRE          // Domestic wire transfer
  ACH           // ACH transfer (slower, cheaper)
  INTERNATIONAL // International wire (SWIFT)
  CHECK         // Physical check
}

enum PayeeStatus {
  PENDING       // Not yet processed
  QUEUED        // Queued for payout
  PROCESSING    // Bridge is processing
  COMPLETED     // Funds sent
  FAILED        // Transfer failed
}

// ============================================================================
// ACTIVITY LOG (Audit Trail)
// ============================================================================

model ActivityLog {
  id          String   @id @default(cuid())
  
  // What happened
  action      String   // e.g., "PAYEE_ADDED", "ESCROW_CLOSED"
  details     Json?    // Additional context (NO sensitive data)
  
  // Who did it
  actorWallet String?  // Wallet address that performed action
  actorIp     String?  // IP address (for security auditing)
  
  // Timestamps
  createdAt   DateTime @default(now())
  
  // Relations
  escrow      Escrow   @relation(fields: [escrowId], references: [id], onDelete: Cascade)
  escrowId    String
  
  @@index([escrowId])
  @@index([createdAt])
}

// ============================================================================
// END OF SCHEMA
// ============================================================================
//
// SECURITY CHECKLIST:
// ✅ No routing numbers stored
// ✅ No account numbers stored
// ✅ No SSNs stored
// ✅ No credit card numbers stored
// ✅ Only Bridge.xyz tokenized IDs for banking
// ✅ Audit trail for all actions
// ✅ Role-based access control
//
// ============================================================================
